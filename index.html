<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ğŸ¥ çˆµå£«é¼“ç¯€å¥ç·´ç¿’</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      background: #1a1a2e;
    }

    body {
      font-family: 'PingFang TC', 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      background-attachment: fixed;
      color: #fff;
      touch-action: manipulation;
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow: hidden;
    }

    header {
      text-align: center;
      padding: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 2px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
      color: #fff;
    }

    .subtitle {
      color: #ffd700;
      font-size: 0.8em;
      font-weight: 300;
    }

    .student-login {
      max-width: 500px;
      margin: 50px auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 40px 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .student-login h2 {
      margin-bottom: 20px;
      font-size: 1.8em;
      color: #fff;
    }

    .student-login input {
      width: 100%;
      padding: 18px;
      margin: 18px 0;
      border: none;
      border-radius: 12px;
      font-size: 1.2em;
      background: rgba(255, 255, 255, 0.95);
      text-align: center;
      color: #333;
    }

    .student-login input:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.5);
    }

    .btn-primary {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1.4em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .level-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .level-card {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      padding: 20px 15px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .level-card:active {
      transform: scale(0.95);
    }

    .level-card.level-2 { background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); }
    .level-card.level-3 { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
    .level-card.level-4 { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
    .level-card.level-5 { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }

    .level-card h3 {
      font-size: 1.4em;
      margin-bottom: 8px;
      color: #fff;
    }

    .level-card p {
      font-size: 0.9em;
      opacity: 0.95;
      margin: 3px 0;
      color: #fff;
    }

    .practice-area {
      display: none;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .practice-area.active {
      display: flex;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .back-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 8px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
      backdrop-filter: blur(5px);
    }

    .back-button:active {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(0.95);
    }

    .level-title {
      font-size: 1.3em;
      text-align: center;
      flex: 1;
      color: #fff;
    }

    .score-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .score-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 10px;
      text-align: center;
      backdrop-filter: blur(5px);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .score-label {
      font-size: 0.75em;
      opacity: 0.9;
      margin-bottom: 3px;
      color: #fff;
    }

    .score-value {
      font-size: 1.4em;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .pattern-display {
      background: rgba(0, 0, 0, 0.4);
      padding: 8px;
      border-radius: 10px;
      margin-bottom: 6px;
      backdrop-filter: blur(5px);
      flex-shrink: 0;
    }

    .pattern-display h3 {
      margin-bottom: 6px;
      font-size: 0.9em;
      color: #fff;
    }

    .pattern-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .drum-labels {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-right: 8px;
      border-right: 2px solid rgba(255, 255, 255, 0.3);
    }

    .drum-label {
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      font-weight: bold;
      color: #ffd700;
      background: rgba(255, 215, 0, 0.2);
      border-radius: 6px;
      padding: 3px 10px;
      min-width: 40px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .pattern-grid-container {
      flex: 1;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .pattern-grid-container::-webkit-scrollbar {
      height: 6px;
    }

    .pattern-grid-container::-webkit-scrollbar-thumb {
      background: rgba(255, 215, 0, 0.5);
      border-radius: 3px;
    }

    .pattern-grid {
      display: grid;
      grid-template-columns: repeat(16, 1fr);
      gap: 4px;
    }

    .beat-cell {
      aspect-ratio: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.2s;
      min-width: 22px;
    }

    .beat-cell.active {
      background: #ffd700;
      box-shadow: 0 0 10px #ffd700;
      border-color: #ffd700;
    }

    .beat-cell.current {
      border: 2px solid #00ff00;
      box-shadow: 0 0 15px #00ff00;
      transform: scale(1.1);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      justify-content: center;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .control-button {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .control-button:active {
      transform: scale(0.95);
    }

    .control-button:disabled {
      opacity: 0.5;
    }

    .control-button.playing {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .tempo-control {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 15px;
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }

    .tempo-control label {
      font-size: 0.9em;
      color: #fff;
      white-space: nowrap;
    }

    .tempo-control input[type="range"] {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      outline: none;
    }

    .tempo-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      background: #ffd700;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
    }

    .tempo-display {
      font-size: 1em;
      font-weight: bold;
      min-width: 70px;
      text-align: center;
      color: #fff;
    }

    .drum-kit {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      flex: 1;
      min-height: 0;
    }

    .drum-pad {
      background: linear-gradient(145deg, #2c3e50, #34495e);
      border: 3px solid #ecf0f1;
      border-radius: 15px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.1s ease;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      touch-action: manipulation;
      min-height: 0;
    }

    .drum-pad:active {
      transform: scale(0.93);
    }

    .drum-pad.hit {
      background: linear-gradient(145deg, #ffd700, #ffed4e);
      border-color: #fff;
      transform: scale(1.05);
    }

    .drum-icon {
      font-size: 2.5em;
      margin-bottom: 5px;
      color: #fff;
    }

    .drum-name {
      font-size: 1em;
      margin-bottom: 4px;
      color: #fff;
    }

    .drum-key {
      font-size: 0.85em;
      opacity: 0.8;
      background: rgba(0, 0, 0, 0.3);
      padding: 4px 8px;
      border-radius: 5px;
      color: #ffd700;
    }

    .countdown {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 8em;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
      z-index: 3000;
      display: none;
      animation: countPulse 1s ease;
      pointer-events: none;
    }

    .countdown.show {
      display: block;
    }

    @keyframes countPulse {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .feedback {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 25px 45px;
      border-radius: 15px;
      font-size: 1.8em;
      font-weight: bold;
      display: none;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .feedback.show {
      display: block;
      animation: feedbackPop 0.4s ease;
    }

    @keyframes feedbackPop {
      0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .feedback.perfect {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: #fff;
    }

    .feedback.miss {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
    }

    .result-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .result-modal.show {
      display: flex;
    }

    .result-content {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      padding: 40px;
      border-radius: 25px;
      text-align: center;
      max-width: 600px;
      box-shadow: 0 15px 60px rgba(0, 0, 0, 0.6);
      border: 3px solid rgba(255, 215, 0, 0.3);
      margin: 20px;
    }

    .result-content h2 {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .result-stats {
      margin: 30px 0;
    }

    .result-stat {
      margin: 15px 0;
      font-size: 1.4em;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      color: #fff;
    }

    .result-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }

    .encouragement {
      margin: 20px 0;
      font-size: 1.4em;
      color: #ffd700;
    }

    /* æ©«å‘æ¨¡å¼å„ªåŒ– */
    @media screen and (orientation: landscape) {
      .container {
        padding: 8px;
      }

      .level-selector {
        grid-template-columns: repeat(5, 1fr);
      }

      .drum-kit {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* ç›´å‘æ¨¡å¼å„ªåŒ– */
    @media screen and (orientation: portrait) {
      .container {
        padding: 10px;
      }

      .level-selector {
        grid-template-columns: repeat(3, 1fr);
      }

      .drum-kit {
        grid-template-columns: repeat(2, 1fr);
      }

      .pattern-container {
        flex-direction: column;
      }

      .drum-labels {
        flex-direction: row;
        border-right: none;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        padding-right: 0;
        padding-bottom: 6px;
        justify-content: space-around;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¥ çˆµå£«é¼“ç¯€å¥ç·´ç¿’</h1>
      <p class="subtitle" id="welcomeText">iPad å°ˆç”¨ç‰ˆ</p>
    </header>

    <!-- å­¸ç”Ÿç™»å…¥å€ -->
    <div class="student-login" id="loginArea">
      <h2>ğŸ‘‹ è«‹è¼¸å…¥æ‚¨çš„å§“å</h2>
      <input type="text" id="studentName" placeholder="è¼¸å…¥å§“åé–‹å§‹ç·´ç¿’..." maxlength="20" autocomplete="off">
      <button class="btn-primary" onclick="login()">é–‹å§‹ç·´ç¿’ ğŸµ</button>
    </div>

    <!-- é—œå¡é¸æ“‡ -->
    <div class="level-selector" id="levelSelector" style="display: none;">
      <div class="level-card" onclick="selectLevel(1)">
        <h3>â­ L1</h3>
        <p>åŸºç¤å››æ‹å­</p>
        <p>80 BPM</p>
      </div>
      <div class="level-card level-2" onclick="selectLevel(2)">
        <h3>â­â­ L2</h3>
        <p>æ–æ»¾ç¯€å¥</p>
        <p>100 BPM</p>
      </div>
      <div class="level-card level-3" onclick="selectLevel(3)">
        <h3>â­â­â­ L3</h3>
        <p>8 Beat è®ŠåŒ–</p>
        <p>120 BPM</p>
      </div>
      <div class="level-card level-4" onclick="selectLevel(4)">
        <h3>â­â­â­â­ L4</h3>
        <p>16 Beat ç¯€å¥</p>
        <p>110 BPM</p>
      </div>
      <div class="level-card level-5" onclick="selectLevel(5)">
        <h3>â­â­â­â­â­ L5</h3>
        <p>çˆµå£« Swing</p>
        <p>140 BPM</p>
      </div>
    </div>

    <!-- ç·´ç¿’å€ -->
    <div class="practice-area" id="practiceArea">
      <div class="top-bar">
        <button class="back-button" onclick="backToLevels()">â† è¿”å›</button>
        <h2 class="level-title" id="levelTitle"></h2>
      </div>

      <div class="score-board">
        <div class="score-item">
          <div class="score-label">ğŸ¯ æº–ç¢ºåº¦</div>
          <div class="score-value" id="accuracy">0%</div>
        </div>
        <div class="score-item">
          <div class="score-label">ğŸ”¥ é€£æ“Š</div>
          <div class="score-value" id="combo">0</div>
        </div>
        <div class="score-item">
          <div class="score-label">â­ åˆ†æ•¸</div>
          <div class="score-value" id="score">0</div>
        </div>
      </div>

      <div class="pattern-display">
        <h3>ğŸ¼ ç¯€å¥å‹æ…‹</h3>
        <div class="pattern-container">
          <div class="drum-labels">
            <div class="drum-label">S</div>
            <div class="drum-label">A</div>
            <div class="drum-label">D</div>
            <div class="drum-label">F</div>
          </div>
          <div class="pattern-grid-container">
            <div class="pattern-grid" id="patternGrid"></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="control-button" id="playButton" onclick="togglePlay()">â–¶ é–‹å§‹</button>
        <button class="control-button" onclick="resetPractice()">â†» é‡ç½®</button>
        <button class="control-button" id="finishButton" onclick="finishPractice()" disabled>âœ“ å®Œæˆ</button>
        <div class="tempo-control">
          <label>ğŸµ é€Ÿåº¦</label>
          <input type="range" id="tempoSlider" min="60" max="180" value="80" oninput="updateTempo()">
          <span class="tempo-display" id="tempoDisplay">80 BPM</span>
        </div>
      </div>

      <div class="drum-kit">
        <div class="drum-pad" data-drum="snare" ontouchstart="hitDrum('snare', event)" ontouchend="releaseDrum(event)">
          <div class="drum-icon">â—</div>
          <div class="drum-name">Snare</div>
          <div class="drum-key">A</div>
        </div>
        <div class="drum-pad" data-drum="hihat" ontouchstart="hitDrum('hihat', event)" ontouchend="releaseDrum(event)">
          <div class="drum-icon">âŠ™</div>
          <div class="drum-name">Hi-Hat</div>
          <div class="drum-key">S</div>
        </div>
        <div class="drum-pad" data-drum="kick" ontouchstart="hitDrum('kick', event)" ontouchend="releaseDrum(event)">
          <div class="drum-icon">â—</div>
          <div class="drum-name">Kick</div>
          <div class="drum-key">D</div>
        </div>
        <div class="drum-pad" data-drum="crash" ontouchstart="hitDrum('crash', event)" ontouchend="releaseDrum(event)">
          <div class="drum-icon">âœ±</div>
          <div class="drum-name">Crash</div>
          <div class="drum-key">F</div>
        </div>
      </div>
    </div>

    <!-- å€’æ•¸è¨ˆæ™‚é¡¯ç¤º -->
    <div class="countdown" id="countdown"></div>

    <!-- å›é¥‹æç¤º -->
    <div class="feedback" id="feedback"></div>

    <!-- çµæœå½ˆçª— -->
    <div class="result-modal" id="resultModal">
      <div class="result-content">
        <h2>ğŸ‰ å®Œæˆï¼</h2>
        <div class="result-stats">
          <div class="result-stat">ğŸ† åˆ†æ•¸: <span id="finalScore" style="color: #ffd700;">0</span></div>
          <div class="result-stat">ğŸ¯ æº–ç¢ºåº¦: <span id="finalAccuracy" style="color: #3498db;">0%</span></div>
          <div class="result-stat">ğŸ”¥ æœ€é«˜é€£æ“Š: <span id="maxCombo" style="color: #e74c3c;">0</span></div>
        </div>
        <div class="encouragement" id="encouragement"></div>
        <div class="result-buttons">
          <button class="control-button" onclick="closeResultModal()">è¿”å›é—œå¡</button>
          <button class="control-button" onclick="retryLevel()">å†ç·´ä¸€æ¬¡</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // éŸ³è¨Šä¸Šä¸‹æ–‡
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // é—œå¡è¨­å®š
    const levels = {
      1: {
        name: "â­ Level 1 - åŸºç¤å››æ‹å­",
        bpm: 80,
        pattern: {
          hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
          snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
          kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
          crash: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        }
      },
      2: {
        name: "â­â­ Level 2 - æ–æ»¾åŸºæœ¬ç¯€å¥",
        bpm: 100,
        pattern: {
          hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
          snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
          kick: [1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],
          crash: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        }
      },
      3: {
        name: "â­â­â­ Level 3 - 8 Beat è®ŠåŒ–",
        bpm: 120,
        pattern: {
          hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
          snare: [0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,0],
          kick: [1,0,0,1,0,0,1,0,1,0,0,0,0,0,1,0],
          crash: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        }
      },
      4: {
        name: "â­â­â­â­ Level 4 - 16 Beat ç¯€å¥",
        bpm: 110,
        pattern: {
          hihat: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
          snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
          kick: [1,0,0,0,0,0,1,0,0,1,0,0,0,0,1,0],
          crash: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        }
      },
      5: {
        name: "â­â­â­â­â­ Level 5 - çˆµå£« Swing",
        bpm: 140,
        pattern: {
          hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
          snare: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
          kick: [1,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],
          crash: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        }
      }
    };

    // éŠæˆ²ç‹€æ…‹è®Šæ•¸
    let studentName = '';
    let currentLevel = 1;
    let isPlaying = false;
    let currentBeat = 0;
    let intervalId = null;
    let score = 0;
    let combo = 0;
    let maxComboValue = 0;
    let hits = 0;
    let totalBeats = 0;
    let expectedHits = 0;
    let loops = 0;
    let maxLoops = 4;
    let lastHitTime = {};
    let countdownValue = 0;
    let isCountingDown = false;

    // ========== éŸ³æ•ˆå‡½æ•¸ ==========
    
    function playHiHat() {
      const noise = audioContext.createBufferSource();
      const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.05, audioContext.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < noiseBuffer.length; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      noise.buffer = noiseBuffer;
      
      const filter = audioContext.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.value = 7000;
      
      const gainNode = audioContext.createGain();
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
      
      noise.connect(filter);
      filter.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      noise.start(audioContext.currentTime);
      noise.stop(audioContext.currentTime + 0.05);
    }

    function playSnare() {
      const osc = audioContext.createOscillator();
      const oscGain = audioContext.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(100, audioContext.currentTime);
      osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.1);
      oscGain.gain.setValueAtTime(0.7, audioContext.currentTime);
      oscGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      osc.connect(oscGain);
      
      const noise = audioContext.createBufferSource();
      const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.1, audioContext.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < noiseBuffer.length; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      noise.buffer = noiseBuffer;
      
      const noiseFilter = audioContext.createBiquadFilter();
      noiseFilter.type = 'highpass';
      noiseFilter.frequency.value = 1000;
      
      const noiseGain = audioContext.createGain();
      noiseGain.gain.setValueAtTime(0.4, audioContext.currentTime);
      noiseGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      noise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      
      const masterGain = audioContext.createGain();
      masterGain.gain.value = 0.6;
      
      oscGain.connect(masterGain);
      noiseGain.connect(masterGain);
      masterGain.connect(audioContext.destination);
      
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 0.1);
      noise.start(audioContext.currentTime);
      noise.stop(audioContext.currentTime + 0.1);
    }

    function playKick() {
      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      osc.type = 'sine';
      osc.frequency.setValueAtTime(150, audioContext.currentTime);
      osc.frequency.exponentialRampToValueAtTime(40, audioContext.currentTime + 0.05);
      osc.frequency.exponentialRampToValueAtTime(30, audioContext.currentTime + 0.3);
      
      gainNode.gain.setValueAtTime(1, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      const filter = audioContext.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 200;
      
      osc.connect(filter);
      filter.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 0.3);
    }

    function playCrash() {
      const noise = audioContext.createBufferSource();
      const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.8, audioContext.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < noiseBuffer.length; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      noise.buffer = noiseBuffer;
      
      const filter1 = audioContext.createBiquadFilter();
      filter1.type = 'bandpass';
      filter1.frequency.value = 5000;
      filter1.Q.value = 1;
      
      const filter2 = audioContext.createBiquadFilter();
      filter2.type = 'highpass';
      filter2.frequency.value = 3000;
      
      const gainNode = audioContext.createGain();
      gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
      
      noise.connect(filter1);
      filter1.connect(filter2);
      filter2.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      noise.start(audioContext.currentTime);
      noise.stop(audioContext.currentTime + 0.8);
    }

    function playSound(drum) {
      if (drum === 'hihat') {
        playHiHat();
      } else if (drum === 'snare') {
        playSnare();
      } else if (drum === 'kick') {
        playKick();
      } else if (drum === 'crash') {
        playCrash();
      }
    }

    function playClick() {
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.frequency.value = 1000;
      osc.connect(gain);
      gain.connect(audioContext.destination);
      gain.gain.setValueAtTime(0.3, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 0.05);
    }

    // ========== éŠæˆ²æ§åˆ¶å‡½æ•¸ ==========

    function login() {
      const name = document.getElementById('studentName').value.trim();
      if (name === '') {
        alert('è«‹è¼¸å…¥å§“å');
        return;
      }
      
      studentName = name;
      document.getElementById('loginArea').style.display = 'none';
      document.getElementById('levelSelector').style.display = 'grid';
      document.getElementById('welcomeText').textContent = `æ­¡è¿ ${studentName}ï¼ğŸ‰`;
    }

    function hitDrum(drum, event) {
      if (event) {
        event.preventDefault();
      }
      
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      const now = Date.now();
      if (lastHitTime[drum] && now - lastHitTime[drum] < 80) {
        return;
      }
      lastHitTime[drum] = now;
      
      playSound(drum);
      
      const pad = document.querySelector(`[data-drum="${drum}"]`);
      pad.classList.add('hit');

      if (isPlaying && !isCountingDown) {
        checkAccuracy(drum);
      }
    }

    function releaseDrum(event) {
      if (event) {
        event.preventDefault();
      }
      
      setTimeout(() => {
        document.querySelectorAll('.drum-pad.hit').forEach(pad => {
          pad.classList.remove('hit');
        });
      }, 120);
    }

    function checkAccuracy(drum) {
      const pattern = levels[currentLevel].pattern;
      const expected = pattern[drum][currentBeat];
      
      if (expected === 1) {
        hits++;
        combo++;
        if (combo > maxComboValue) {
          maxComboValue = combo;
        }
        score += 10 * combo;
        showFeedback('perfect', 'å®Œç¾! ğŸµ');
      } else {
        combo = 0;
        showFeedback('miss', 'å¤±èª¤ ğŸ˜…');
      }
      
      updateScore();
    }

    function showFeedback(type, message) {
      const feedback = document.getElementById('feedback');
      feedback.className = 'feedback show ' + type;
      feedback.textContent = message;
      
      setTimeout(() => {
        feedback.classList.remove('show');
      }, 400);
    }

    function updateScore() {
      document.getElementById('score').textContent = score;
      document.getElementById('combo').textContent = combo;
      
      if (expectedHits > 0 && loops > 0) {
        const accuracy = Math.round((hits / (expectedHits * loops)) * 100);
        document.getElementById('accuracy').textContent = accuracy + '%';
      }
    }

    function selectLevel(level) {
      currentLevel = level;
      document.getElementById('levelSelector').style.display = 'none';
      document.getElementById('practiceArea').classList.add('active');
      document.getElementById('levelTitle').textContent = levels[level].name;
      document.getElementById('tempoSlider').value = levels[level].bpm;
      document.getElementById('tempoDisplay').textContent = levels[level].bpm + ' BPM';
      
      displayPattern();
      resetPractice();
    }

    function backToLevels() {
      stopPlay();
      document.getElementById('levelSelector').style.display = 'grid';
      document.getElementById('practiceArea').classList.remove('active');
    }

    function displayPattern() {
      const pattern = levels[currentLevel].pattern;
      const grid = document.getElementById('patternGrid');
      grid.innerHTML = '';
      
      expectedHits = 0;
      const drums = ['snare', 'hihat', 'kick', 'crash'];
      drums.forEach(drum => {
        pattern[drum].forEach((beat, index) => {
          const cell = document.createElement('div');
          cell.className = 'beat-cell';
          cell.dataset.drum = drum;
          cell.dataset.beat = index;
          if (beat === 1) {
            cell.classList.add('active');
            expectedHits++;
          }
          grid.appendChild(cell);
        });
      });
    }

    function togglePlay() {
      if (isPlaying) {
        stopPlay();
      } else {
        startCountdown();
      }
    }

    function startCountdown() {
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      isCountingDown = true;
      countdownValue = 4;
      document.getElementById('playButton').disabled = true;
      
      const countdownEl = document.getElementById('countdown');
      const bpm = parseInt(document.getElementById('tempoSlider').value);
      const beatInterval = (60 / bpm) * 1000;
      
      function showCount() {
        if (countdownValue > 0) {
          countdownEl.textContent = countdownValue;
          countdownEl.classList.add('show');
          playClick();
          
          setTimeout(() => {
            countdownEl.classList.remove('show');
          }, beatInterval * 0.8);
          
          countdownValue--;
          setTimeout(showCount, beatInterval);
        } else {
          isCountingDown = false;
          startPlay();
        }
      }
      
      showCount();
    }

    function startPlay() {
      isPlaying = true;
      currentBeat = 0;
      if (loops === 0) {
        score = 0;
        hits = 0;
        combo = 0;
      }
      
      document.getElementById('playButton').innerHTML = 'â¸ æš«åœ';
      document.getElementById('playButton').classList.add('playing');
      document.getElementById('playButton').disabled = false;
      document.getElementById('finishButton').disabled = true;
      
      const bpm = parseInt(document.getElementById('tempoSlider').value);
      const interval = (60 / bpm) * 1000 / 4;
      
      intervalId = setInterval(() => {
        updateBeatDisplay();
        playPatternBeat();
        
        currentBeat++;
        if (currentBeat >= 16) {
          currentBeat = 0;
          loops++;
          
          if (loops >= maxLoops) {
            stopPlay();
            document.getElementById('finishButton').disabled = false;
            showFeedback('perfect', 'å®Œæˆï¼ğŸ‰');
          }
        }
      }, interval);
    }

    function stopPlay() {
      isPlaying = false;
      isCountingDown = false;
      clearInterval(intervalId);
      document.getElementById('playButton').innerHTML = 'â–¶ é–‹å§‹';
      document.getElementById('playButton').classList.remove('playing');
      document.getElementById('playButton').disabled = false;
      clearBeatDisplay();
    }

    function updateBeatDisplay() {
      document.querySelectorAll('.beat-cell.current').forEach(cell => {
        cell.classList.remove('current');
      });
      
      document.querySelectorAll(`.beat-cell[data-beat="${currentBeat}"]`).forEach(cell => {
        cell.classList.add('current');
      });
    }

    function clearBeatDisplay() {
      document.querySelectorAll('.beat-cell.current').forEach(cell => {
        cell.classList.remove('current');
      });
    }

    function playPatternBeat() {
      const pattern = levels[currentLevel].pattern;
      const drums = ['hihat', 'snare', 'kick', 'crash'];
      
      totalBeats++;
      
      drums.forEach(drum => {
        if (pattern[drum][currentBeat] === 1) {
          playSound(drum);
        }
      });
    }

    function resetPractice() {
      stopPlay();
      score = 0;
      combo = 0;
      maxComboValue = 0;
      hits = 0;
      totalBeats = 0;
      currentBeat = 0;
      loops = 0;
      
      displayPattern();
      updateScore();
      document.getElementById('finishButton').disabled = true;
    }

    function updateTempo() {
      const bpm = document.getElementById('tempoSlider').value;
      document.getElementById('tempoDisplay').textContent = bpm + ' BPM';
      
      if (isPlaying) {
        stopPlay();
        startCountdown();
      }
    }

    function finishPractice() {
      const accuracy = expectedHits > 0 ? Math.round((hits / (expectedHits * maxLoops)) * 100) : 0;
      
      document.getElementById('finalScore').textContent = score;
      document.getElementById('finalAccuracy').textContent = accuracy + '%';
      document.getElementById('maxCombo').textContent = maxComboValue;
      
      let encouragementText = '';
      if (accuracy >= 95) {
        encouragementText = 'ğŸŒŸ å®Œç¾æ¼”å¥ï¼ä½ æ˜¯ç¯€å¥å¤§å¸«ï¼';
      } else if (accuracy >= 80) {
        encouragementText = 'ğŸ‘ è¡¨ç¾å„ªç•°ï¼ç¹¼çºŒåŠ æ²¹ï¼';
      } else if (accuracy >= 60) {
        encouragementText = 'ğŸ’ª ä¸éŒ¯çš„å˜—è©¦ï¼æŒçºŒç·´ç¿’æœƒæ›´å¥½ï¼';
      } else {
        encouragementText = 'ğŸ˜Š åˆ¥æ°£é¤’ï¼Œå¤šç·´ç¿’å°±æœƒé€²æ­¥ï¼';
      }
      document.getElementById('encouragement').textContent = encouragementText;
      
      document.getElementById('resultModal').classList.add('show');
    }

    function closeResultModal() {
      document.getElementById('resultModal').classList.remove('show');
      backToLevels();
    }

    function retryLevel() {
      document.getElementById('resultModal').classList.remove('show');
      resetPractice();
    }

    // ========== äº‹ä»¶ç›£è½ ==========

    document.addEventListener('touchmove', function(e) {
      const target = e.target;
      if (!target.closest('.container')) {
        e.preventDefault();
      }
    }, { passive: false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    document.getElementById('studentName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        login();
      }
    });
  </script>
</body>
</html>
